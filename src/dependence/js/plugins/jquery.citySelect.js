/**
 *
 * Spice
 * 
 * 详细用法请参考：http://10.8.21.101
 * @ author Razy
 * @ version 3.0.0
 *
 */

!function(a){"use strict";function b(b,c){if(!b||a.isPlainObject(b))return!1;var d=[];return a(b).each(function(b,f){var g=a(f),h=g.data("spice.citySelect");h||g.data("spice.citySelect",h=new e(g,c)),d.push(h)}),d}var c={defaultText:["省份/直辖市","市","县/区"],defaultData:"1",btnClass:null,btnAddClass:"open",contentClass:null,beyondNum:10,beyondHgt:200,events:null,callBack:null},d={getPCDObj:function(b){return b&&!a.isEmptyObject(districtJson[b])?districtJson[b]:{}},getDefaultSelectVal:function(b){return a.map(a("select",b),function(b){var c=a("option:selected",b);return c.attr("value")+"-"+c.text()})},defaultSelect:function(b,c){var e=c.opt,f=c.elem;b.on("change",function(){var b=a(this),g=b.prev(".btn"),h=+b.attr("city-index"),i=a("option:selected",b).attr("value"),j=a("option:selected",b).text();b.removeAttr("city-curval"),0!=g.length&&a("span:eq(0)",g).html(j);var k=d.getPCDObj(i),l=a("[city-index="+ ++h+"]",f),m=l.attr("city-curval");return 0==l.length?(e.callBack&&a.isFunction(e.callBack)&&e.callBack(d.getDefaultSelectVal(f),f),!1):void l.removeAttr("city-curval").html(d.getOptionHtml(h,k,m,c)).trigger("change")})},hide:function(b){var c=a(".sub-menu",".form-select");c.hide(),c.prev().removeClass(b)},getSimulationSelectVal:function(b,c){return a.map(a(b.contentClass,c),function(b){var c=a("li.selected",b);return c.attr("city-value")+"-"+c.text()})},simulationSelect:function(b,c){var e=c.opt,f=c.elem,g=+b.attr("city-index"),h=c.pcdBtn.eq(g);h.on("tap",function(){var f=b.closest(".sub-menu");return f.is(":visible")?(d.hide(e.btnAddClass),!1):(d.hide(e.btnAddClass),void d.setCss(c,f,function(){f.show(),h.addClass(e.btnAddClass),e.events&&a.isFunction(e.events)&&e.events(f),d.setScrollCss(c,f)}))}),b.on("tap","li",function(){var b=a(this),g=b.parent(),h=+g.attr("city-index"),i=b.attr("city-value");b.addClass("selected").siblings().removeClass("selected"),g.removeAttr("city-curval");var j=a("span:eq(0)",b.closest(".sub-menu").prev());if(j.html()==i)return d.hide(e.btnAddClass),!1;j.html(b.text()),d.hide(e.btnAddClass);var k=d.getPCDObj(i),l=a("[city-index="+ ++h+"]",f),m=l.attr("city-curval");if(0==l.length)return e.callBack&&a.isFunction(e.callBack)&&e.callBack(d.getSimulationSelectVal(e,f),f),!1;l.html(d.getOptionHtml(h,k,m,c));var n=a("li.selected",l);0==n.length&&(n=a("li:eq(0)",l)),n.trigger("tap")})},activate:function(a,b){b.isDefault?d.defaultSelect(a,b):d.simulationSelect(a,b)},getOptionHtml:function(b,c,d,e){if(e.isDefault){var f='<option value="">'+(e.opt.defaultText[b]||"")+"</option>";a.each(c,function(a,b){f+='<option value="'+a+'" '+(a==d||b==d?"selected":"")+" >"+b+"</option>"})}else{var f='<li city-value=""><a>'+(e.opt.defaultText[b]||"")+"</a></li>";a.each(c,function(a,b){f+="<li"+(a==d||b==d?' class="selected"':"")+' city-value="'+a+'" ><a>'+b+"</a></li>"})}return f},initScrollCss:function(b){a(".viewport",b).css({height:""}),a(".overview",b).css({marginTop:""}),a(".scrollbar",b).css({height:""}),a(".track",b).css({height:""}),a(".thumb",b).css({height:"",marginTop:""})},setScrollCss:function(b,c){a("li",c).length>b.opt.beyondNum?c.removeClass("no-scroll-scrollbar"):c.addClass("no-scroll-scrollbar")},setCss:function(b,c,e){var f=b.opt,g=f.beyondNum,h=f.beyondHgt;d.initScrollCss(c),c.removeData("plugin_tinyscrollbar"),a(".viewport",c).css({height:a("li",c).length>g?h:"auto"}),e()}},e=function(b,d){var e=this;e.opt=a.extend({},c,d),e.elem=b,e.init()};e.prototype={init:function(){var b=this,c=b.opt;if(!window.districtJson||a.isEmptyObject(window.districtJson))return!1;var e=b.isDefault=!(c.btnClass&&c.contentClass);if(e?b.select=a("select",b.elem):(b.select=a(c.contentClass,b.elem),b.pcdBtn=a(c.btnClass,b.elem)),0==b.select.length)return!1;if(a.each(b.select,function(e,f){var g=a(f),h=g.attr("city-curval");g.attr({"city-index":e}).html(d.getOptionHtml(e,0==e?window.districtJson[c.defaultData]:{},h,b)),d.activate(g,b)}),e)b.select.eq(0).trigger("change");else{var f=a("li.selected",b.select.eq(0));0==f.length&&(f=a("li:eq(0)",b.select.eq(0))),f.trigger("tap"),a("html").on("tap",function(b){var e=a(b.target);e.hasClass("form-select")||0!=e.parents(".form-select").length||d.hide(c.btnAddClass)})}},getSelectVal:function(){return this.isDefault?d.getDefaultSelectVal(this.elem):d.getSimulationSelectVal(this.opt,this.elem)},setSelectVal:function(b){if(!a.isArray(b)||0==b.length)return!1;if(this.select){this.select.attr("city-curval",function(){return b[a(this).attr("city-index")]});var c=null;this.isDefault?(a("option",this.select.eq(0)).removeAttr("selected"),c=a("option:contains("+b[0]+")",this.select.eq(0)),0===c.length&&(c=a("option[value="+b[0]+"]",this.select.eq(0))),c.attr("selected","selected"),this.select.eq(0).trigger("change")):(a("li",this.select.eq(0)).removeAttr("class"),c=a("li:contains("+b[0]+")",this.select.eq(0)),0===c.length&&(c=a("li[city-value="+b[0]+"]",this.select.eq(0))),c.addClass("selected").trigger("tap"))}}},a.spice.citySelect=b}(jQuery);